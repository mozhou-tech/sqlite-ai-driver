.PHONY: install dev build api frontend seed clean-lock stop force-clean

# å®‰è£…å‰ç«¯ä¾èµ–
install:
	pnpm install
	cd api && go mod tidy


# å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆå‰ç«¯å’Œåç«¯ï¼‰
dev: stop
	@echo "å¯åŠ¨åç«¯ API æœåŠ¡å™¨ï¼ˆä½¿ç”¨ air çƒ­é‡è½½ï¼‰..."
	@cd api && air &
	@sleep 2
	@echo "å¯åŠ¨å‰ç«¯å¼€å‘æœåŠ¡å™¨..."
	@pnpm dev

# ä»…å¯åŠ¨åç«¯
api:
	cd api && go run .

# ä»…å¯åŠ¨å‰ç«¯
frontend:
	pnpm dev

# æ„å»ºå‰ç«¯
build:
	pnpm build

# æ„å»ºåç«¯
build-api:
	cd api && go build -o browser-api .

# ç”Ÿæˆç¤ºä¾‹æ•°æ®
seed:
	@echo "ğŸŒ± ç”Ÿæˆç¤ºä¾‹æ•°æ®..."
	@cd api && go run seed.go

# ç”Ÿæˆå¤§é‡æ•°æ®ç”¨äºæ€§èƒ½æµ‹è¯•ï¼ˆ1ä¸‡æ¡ï¼‰
largeseed:
	@echo "ğŸš€ ç”Ÿæˆå¤§é‡æ•°æ®ç”¨äºæ€§èƒ½æµ‹è¯•ï¼ˆ1ä¸‡æ¡ï¼‰..."
	@cd api && go run largeseed.go

# åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹
stop:
	@echo "ğŸ›‘ åœæ­¢åç«¯æœåŠ¡..."
	@-lsof -ti :40121 | xargs kill -9 2>/dev/null || true
	@-pkill -f "air" || true
	@-pkill -f "tmp/main" || true
	@-pkill -f "go run.*main.go" || true
	@-pkill -f "browser-api" || true
	@-ps aux | grep -E "[t]mp/main|[g]o run.*main.go|[b]rowser-api" | awk '{print $$2}' | xargs kill -9 2>/dev/null || true
	@sleep 2
	@echo "âœ… åç«¯æœåŠ¡å·²åœæ­¢"

# æ¸…ç†æ•°æ®åº“é”æ–‡ä»¶ï¼ˆå½“é‡åˆ°æ•°æ®åº“é”å®šé”™è¯¯æ—¶ä½¿ç”¨ï¼‰
clean-lock:
	@echo "ğŸ§¹ æ¸…ç†æ•°æ®åº“é”æ–‡ä»¶..."
	@echo "âš ï¸  æ³¨æ„: DuckDB ä½¿ç”¨æ–‡ä»¶é”ï¼Œé€šå¸¸éœ€è¦å…ˆåœæ­¢ç›¸å…³è¿›ç¨‹"
	@echo "   å»ºè®®å…ˆè¿è¡Œ 'make stop' åœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹"
	@rm -f api/data/browser-db/.browser-db.lock
	@rm -f api/data/browser-db/LOCK
	@rm -f api/data/browser-db/graph/LOCK 2>/dev/null || true
	@rm -f api/data/browser-db/browser.db-wal 2>/dev/null || true
	@rm -f api/data/browser-db/browser.db-shm 2>/dev/null || true
	@find api/data -name "*.lock" -delete 2>/dev/null || true
	@echo "âœ… é”æ–‡ä»¶å·²æ¸…ç†"

# å¼ºåˆ¶æ¸…ç†ï¼šåœæ­¢æ‰€æœ‰ç›¸å…³è¿›ç¨‹å¹¶æ¸…ç†é”æ–‡ä»¶
force-clean: stop
	@echo "âœ… å¼ºåˆ¶æ¸…ç†å®Œæˆ"

test:
	cd api &&  go mod tidy && go test ./...

build-api:
	@echo "ğŸ—ï¸  æ„å»ºåç«¯æœåŠ¡ (ä¸åŒ…å« Swagger)..."
	@cd api && go mod tidy && go build -ldflags="-s -w" -o browser-api .
	@gsa api/browser-api

